<!-- File: public/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Click-to-Copy Button Maker</title>
<style>
  .hidden{display:none!important}
  :root{--radius:14px}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.4;background:#0b0f10;color:#e8e9ea;min-height:100vh;padding:24px;display:grid;grid-template-rows:auto 1fr;place-items:start center}
  .app{width:min(1100px,100%);background:#12151a;border:1px solid #222831;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:20px;position:relative}

  /* Title first, toolbar second (always) */
  .header{display:flex;flex-direction:column;gap:12px;margin-bottom:12px}
  .titlewrap{display:flex;flex-direction:column;gap:4px}
  h1{font-size:20px;margin:0}
  .muted{color:#a7b1c2;font-size:13px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;width:100%;justify-content:flex-start}

  .primary,.danger,.util{padding:10px 14px;border:0;border-radius:12px;font-weight:600;cursor:pointer;white-space:nowrap}
  .primary{background:#3a9ff5;color:#fff}
  .danger{background:#e5484d;color:#fff}
  .util{background:transparent;border:1px solid #2a313b;color:#e8e9ea}
  .danger:disabled,.primary:disabled,.util:disabled{opacity:.6;cursor:not-allowed}

  .filters-wrapper{position:relative}
  /* Centered dropdown under Filters button */
  .dropdown{position:absolute;left:50%;transform:translateX(-50%);top:calc(100% + 8px);z-index:20;background:#10141b;border:1px solid #2a313b;border-radius:12px;padding:10px;width:min(420px,92vw);display:none;box-shadow:0 10px 30px rgba(0,0,0,.3)}
  .dropdown.show{display:block}

  /* Export floating popover (overlays Add dialog) */
  .popover{position:fixed;z-index:1000;background:#10141b;border:1px solid #2a313b;border-radius:12px;padding:10px;width:min(420px,92vw);display:none;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .popover.show{display:block}
  .menu-btn{display:block;width:100%;text-align:left;padding:8px 10px;border-radius:8px;border:1px solid #2a313b;background:#0e1116;color:#e8e9ea;cursor:pointer}
  .menu-btn:hover{background:#171b22;border-color:#3a9ff5}
  .dropdown hr,.popover hr{border:0;border-top:1px solid #2a313b;margin:8px 0}

  .grid{margin-top:8px;display:grid;gap:12px;grid-template-columns:repeat(4,minmax(0,1fr))}
  @media (max-width:920px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media (max-width:520px){.grid{grid-template-columns:1fr}}
  .item{position:relative}
  .copy-btn{--accent:#2a313b;width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a313b;background:#161a21;color:#e8e9ea;cursor:pointer;text-align:left;display:flex;justify-content:space-between;align-items:center;gap:8px;transition:background .15s,border-color .15s,transform .02s,box-shadow .15s}
  .copy-btn:hover{background:#1a1f27;border-color:var(--accent);box-shadow:0 0 0 3px color-mix(in oklab,var(--accent) 30%,transparent)}
  .copy-btn:active{transform:translateY(1px)}
  .leftcol{display:grid;gap:6px;min-width:0}
  .title{font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .hint{font-size:12px;color:#a7b1c2}
  .tags{display:flex;gap:6px;flex-wrap:wrap}
  .tag{font-size:11px;padding:2px 6px;border:1px solid #2a313b;border-radius:999px;color:#cdd6e1}

  .tag-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #2a313b;cursor:pointer;font-size:12px}
  .tag-chip[aria-pressed="true"]{box-shadow:0 0 0 2px rgba(255,255,255,.06) inset}
  .chip-dot{width:10px;height:10px;border-radius:50%;display:inline-block}

  .control{padding:10px 34px 10px 12px;border-radius:10px;border:1px solid #2a313b;background:#0e1116;color:#e8e9ea;outline:none}
  .control:focus{border-color:#3a9ff5;box-shadow:0 0 0 3px rgba(58,159,245,.25)}
  .search-wrap{position:relative}.search{width:260px;max-width:60vw}
  .clear-btn{position:absolute;right:8px;top:50%;transform:translateY(-50%);border:0;background:transparent;color:#a7b1c2;width:20px;height:20px;border-radius:6px;cursor:pointer;display:none;align-items:center;justify-content:center}
  .clear-btn:hover{color:#fff}.clear-btn.show{display:inline-flex}

  /* >>> Bigger, full-width dialog rows (fix) */
  .dlg-grid .row{display:grid;grid-template-columns:1fr;gap:8px}
  .dlg-grid .row .control{width:100%}
  /* Taller textarea in Add dialog */
  #manage-dialog textarea.control{min-height:180px;resize:vertical}
  /* Keep other textareas reasonable too */
  textarea.control{min-height:140px;resize:vertical}

  .ctxmenu{position:absolute;top:6px;right:6px;z-index:20;min-width:180px;background:#10141b;border:1px solid #2a313b;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:6px;display:none}
  .ctxmenu.show{display:block}
  .ctxmenu .row{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;cursor:pointer;user-select:none}
  .ctxmenu .row:hover{background:#181d25}
  .ctxmenu hr{border:0;border-top:1px solid #2a313b;margin:6px 0}
  .ctxmenu .danger-act{color:#ffb3b6}

  .dropzone{border:1px dashed #2a313b;border-radius:10px;background:#0e1116;padding:14px;text-align:center;cursor:pointer}
  .dropzone:hover,.dropzone.dz-hover{border-color:#3a9ff5;box-shadow:0 0 0 3px rgba(58,159,245,.25)}
  .dz-row{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:8px;color:#a7b1c2;font-size:13px}

  .toast{position:fixed;left:50%;bottom:28px;transform:translateX(-50%) translateY(20px);background:#0b0f14;border:1px solid #2a313b;color:#e8e9ea;padding:10px 14px;border-radius:12px;opacity:0;pointer-events:none;transition:opacity .25s,transform .25s;display:flex;gap:10px;align-items:center;font-size:14px}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  dialog{border:1px solid #2a313b;border-radius:12px;background:#10141b;color:#e8e9ea;padding:16px;width:min(720px,96vw)}
  dialog::backdrop{background:rgba(0,0,0,.55)}

  mark{background:#264f78;color:#fff;border-radius:4px;padding:0 2px}

  /* Auto-compact */
  body.compact .app{padding:14px;border-radius:10px}
  body.compact .toolbar{gap:6px}
  body.compact .primary,body.compact .danger,body.compact .util{padding:8px 10px;border-radius:8px}
  body.compact .search{width:220px;max-width:55vw}
  body.compact .control{padding:8px 30px 8px 10px;border-radius:8px}
  body.compact #manage-dialog textarea.control{min-height:150px} /* a bit smaller but still comfy */
  body.compact .copy-btn{padding:8px 10px;border-radius:10px;gap:6px}
  body.compact .leftcol{gap:4px}
  body.compact .tag{font-size:10px;padding:1px 5px}
  body.compact .grid{gap:8px}
  body.compact .ctxmenu{border-radius:10px;padding:4px;min-width:160px}
  body.compact .ctxmenu .row{padding:5px 7px;border-radius:6px;gap:6px}
  body.compact .toast{padding:8px 10px;border-radius:10px}
</style>
</head>
<body>
  <main class="app" aria-labelledby="app-title">
    <div class="header">
      <div class="titlewrap">
        <h1 id="app-title">Click-to-Copy Button Maker</h1>
        <div class="muted">Right-click (or long-press) a card for its menu. Ctrl/Cmd+K focuses search; Enter copies first result.</div>
      </div>
      <div class="toolbar">
        <div class="search-wrap">
          <input id="search" class="control search" type="text" placeholder="Search title, tags, or text…" />
          <button id="search-clear" class="clear-btn" type="button" aria-label="Clear search">×</button>
        </div>

        <div class="filters-wrapper">
          <button id="filters-btn" class="util" type="button">Filters (0)</button>
          <div id="filters-dd" class="dropdown" role="menu" aria-label="Filters">
            <div class="small" id="filters-summary"></div>
            <div id="filters-list" style="max-height:240px;overflow:auto;display:grid;gap:6px"></div>
            <div style="display:flex;justify-content:space-between;gap:8px;margin-top:8px">
              <button id="filters-mode-toggle" class="util" type="button" title="Toggle ALL/ANY"></button>
              <div style="display:flex;gap:8px">
                <button id="filters-select-all" class="util" type="button">Select all</button>
                <button id="filters-clear" class="util" type="button">Clear</button>
              </div>
            </div>
          </div>
        </div>

        <button id="open-colors" class="util" type="button" title="Edit tag colors">🎨 Tag Colors</button>

        <button id="open-manage" class="primary" type="button">Add</button>
        <button id="select-toggle" class="util" type="button" disabled>Select All</button>
        <button id="delete-selected" class="danger" type="button" disabled>Delete Selected (0)</button>
      </div>
    </div>

    <section>
      <div id="grid" class="grid" role="list" aria-label="Copy buttons"></div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true">
    <span aria-hidden="true">📋</span>
    <span id="toast-msg">Copied.</span>
  </div>

  <!-- Add / Manage dialog -->
  <dialog id="manage-dialog" aria-label="Add / Import / Export">
    <form method="dialog" id="manage-form" class="dlg-grid">
      <h3 style="margin:0">Add / Import / Export</h3>

      <div class="row">
        <label for="btn-title">Button title</label>
        <input id="btn-title" class="control" type="text" maxlength="120" placeholder="e.g., API Key, Greeting, Email Signature" />
      </div>
      <div class="row">
        <label for="btn-text">Text to copy</label>
        <textarea id="btn-text" class="control" placeholder="Paste or type the text that should be copied when the button is clicked."></textarea>
      </div>
      <div class="row">
        <label for="btn-tags">Filters (comma-separated)</label>
        <input id="btn-tags" class="control" type="text" placeholder="e.g., work, personal, snippets" list="tags-datalist" />
        <div id="existing-tags-wrap" class="small" style="margin-top:8px;display:grid;gap:8px">
          <div>Click to toggle tags:</div>
          <div id="existing-tags" style="display:flex;flex-wrap:wrap;gap:8px"></div>
        </div>
      </div>

      <div class="dlg-actions" style="display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:center">
        <div style="display:flex;gap:10px;align-items:center">
          <button id="create" class="primary" type="button">Create</button>
          <span class="small">Tip: Ctrl/Cmd + Enter</span>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button id="open-import" class="util" type="button">Import</button>
          <button id="export-menu-btn" class="util" type="button" aria-haspopup="true" aria-expanded="false">Export ▾</button>
          <button id="clear-all" class="util" type="button">Clear All</button>
          <button id="close-manage" class="util" type="button">Close</button>
        </div>
      </div>
    </form>

    <!-- Floating Export Popover -->
    <div id="export-popover" class="popover" role="menu" aria-label="Export options">
      <div class="small" style="opacity:.9;margin:2px 2px 6px">Buttons</div>
      <button class="menu-btn" data-act="download-buttons" type="button">Download: Buttons (with tags & colors)</button>
      <button class="menu-btn" data-act="copy-buttons" type="button">Copy JSON: Buttons (with tags & colors)</button>
      <hr/>
      <div class="small" style="opacity:.9;margin:2px 2px 6px">Tags</div>
      <button class="menu-btn" data-act="download-tags" type="button">Download: Tags (with colors)</button>
      <button class="menu-btn" data-act="copy-tags" type="button">Copy JSON: Tags (with colors)</button>
    </div>
  </dialog>

  <!-- Import dialog -->
  <dialog id="import-dialog" aria-label="Import Buttons / Tag Colors">
    <form method="dialog" id="import-form" class="dlg-grid">
      <h3 style="margin:0">Import</h3>
      <div class="row">
        <label for="import-json">Paste JSON (from Export)</label>
        <textarea id="import-json" class="control" placeholder='Paste JSON here…' style="min-height:160px"></textarea>
      </div>
      <div class="row">
        <label>Or Drag & Drop / Choose File</label>
        <div id="import-dropzone" class="dropzone" tabindex="0" role="button" aria-label="Drag a JSON file here or click to choose">
          <div>Drag & drop your <strong>.json</strong> here,<br/>or <u>click to choose</u>.</div>
          <div class="dz-row">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
              <input id="import-dedupe" type="checkbox" checked />
              <span>Skip duplicates by title</span>
            </label>
          </div>
        </div>
        <input id="import-file" class="hidden" type="file" accept="application/json,.json" />
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button id="import-cancel" class="util" type="button">Close</button>
        <button id="import-run" class="primary" type="button">Import</button>
      </div>
    </form>
  </dialog>

  <!-- Rename dialog -->
  <dialog id="rename-dialog">
    <form method="dialog" class="dlg-grid" id="rename-form">
      <h3 style="margin:0">Rename button</h3>
      <input id="rename-input" class="control" type="text" maxlength="120" autocomplete="off" />
      <div class="small">Only the title is changed. (Text remains the same.)</div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button id="rename-cancel" class="util" type="button">Cancel</button>
        <button id="rename-save" class="primary" type="button">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Edit tags dialog -->
  <dialog id="tags-dialog">
    <form method="dialog" class="dlg-grid" id="tags-form">
      <h3 style="margin:0">Edit tags</h3>
      <input id="tags-input" class="control" type="text" placeholder="comma, separated, tags" list="tags-datalist" />
      <div class="small" style="margin-top:8px">Click to toggle:</div>
      <div id="edit-existing-tags" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px"></div>
      <div class="small">Tags affect filtering. Use commas.</div>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button id="tags-cancel" class="util" type="button">Cancel</button>
        <button id="tags-save" class="primary" type="button">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Tag Colors dialog -->
  <dialog id="colors-dialog" aria-label="Edit Tag Colors">
    <form method="dialog" id="colors-form" class="dlg-grid">
      <h3 style="margin:0">Edit Tag Colors</h3>
      <div class="small">Pick a color or type a hex (e.g. <code>#3a9ff5</code>). “Reset” reverts to auto color.</div>
      <div id="colors-list" style="display:grid;gap:8px;margin-top:10px;max-height:360px;overflow:auto"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
        <button id="colors-cancel" class="util" type="button">Cancel</button>
        <button id="colors-save" class="primary" type="button">Save</button>
      </div>
    </form>
  </dialog>

  <datalist id="tags-datalist"></datalist>

  <script>
    /* ---------- Utilities & State ---------- */
    const IS_TOUCH=('ontouchstart'in window)||(navigator.maxTouchPoints>0);
    const ALLOW_DND=!IS_TOUCH;
    const STORAGE_KEY='copyButtons:v2';
    const SETTINGS_KEY='copyButtons:settings:v1';
    const TAGS_KEY='copyButtons:tagColors:v1';
    const $=(s)=>document.querySelector(s);

    // Toolbar
    const searchInput=$('#search'), searchClear=$('#search-clear');
    const filtersBtn=$('#filters-btn'), filtersDd=$('#filters-dd'), filtersList=$('#filters-list'), filtersSummary=$('#filters-summary');
    const filtersModeToggle=$('#filters-mode-toggle'), filtersSelectAllBtn=$('#filters-select-all'), filtersClearBtn=$('#filters-clear');
    const openManageBtn=$('#open-manage'), selectToggleBtn=$('#select-toggle'), deleteSelectedBtn=$('#delete-selected');
    const openColorsBtn=$('#open-colors');

    // Manage
    const manageDlg=$('#manage-dialog'), titleInput=$('#btn-title'), textInput=$('#btn-text'), tagsCreateInput=$('#btn-tags');
    const existingTags=$('#existing-tags'); const createBtn=$('#create'), closeManageBtn=$('#close-manage'), clearBtn=$('#clear-all');

    // Export popover
    const exportBtn=$('#export-menu-btn'), exportPop=$('#export-popover');

    // Import dialog
    const openImportBtn=$('#open-import'), importDlg=$('#import-dialog'), importJSON=$('#import-json');
    const importRunBtn=$('#import-run'), importCancelBtn=$('#import-cancel');
    const importDropzone=$('#import-dropzone'), importFile=$('#import-file'), importDedupe=$('#import-dedupe');

    // Other dialogs
    const renameDlg=$('#rename-dialog'), renameInput=$('#rename-input'), renameSaveBtn=$('#rename-save'), renameCancelBtn=$('#rename-cancel');
    const tagsDlg=$('#tags-dialog'), tagsInput=$('#tags-input'), tagsSaveBtn=$('#tags-save'), tagsCancelBtn=$('#tags-cancel'), editExistingTags=$('#edit-existing-tags');
    const colorsDlg=$('#colors-dialog'), colorsList=$('#colors-list'), colorsSaveBtn=$('#colors-save'), colorsCancelBtn=$('#colors-cancel');

    const grid=$('#grid'), toast=$('#toast'), toastMsg=$('#toast-msg'), tagsDatalist=$('#tags-datalist');

    let counter=1; let state=[]; let tagColors={}; let settings={filterMode:'all'};
    const selectedIds=new Set(); const activeFilters=new Set(); let searchQuery='';

    const uid=()=>Math.random().toString(36).slice(2,10)+Date.now().toString(36);
    const sanitizeLabel=(s)=>(s||'').trim()||`Button ${counter}`;
    const sanitizeText=(s)=>(s||'').replace(/\r\n/g,'\n');
    const splitTags=(s)=>(s||'').split(/[,\n]/g).map(t=>t.trim()).filter(Boolean).slice(0,50);
    const norm=(s)=>String(s||'').trim().toLowerCase();
    const PALETTE=['#3a9ff5','#7c5cff','#ef6d6d','#5ec16e','#f59e0b','#00c2d1','#e86ed0','#9dd163','#ef8d48','#4dd0e1','#b388ff','#7dd3fc','#f97393','#8bc34a','#f4b400'];

    function showToast(msg){ toastMsg.textContent=msg; toast.classList.add('show'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.classList.remove('show'),1500); }
    function normalizeHex(hex){ if(!hex) return null; let s=String(hex).trim(); if(s[0]!=='#') s='#'+s; if(/^#([0-9a-fA-F]{3})$/.test(s)){const r=s[1],g=s[2],b=s[3]; s=`#${r}${r}${g}${g}${b}${b}`;} if(/^#([0-9a-fA-F]{6})$/.test(s)) return s.toLowerCase(); return null; }
    function autoColorFor(key){ let h=0; for(let i=0;i<key.length;i++){ h=(h*31 + key.charCodeAt(i))>>>0; } return PALETTE[h % PALETTE.length]; }
    function colorForTag(tag){ const k=norm(tag); const c=tagColors[k]; return normalizeHex(c)||autoColorFor(k); }
    function firstTagColor(tags){ return (tags&&tags.length)?colorForTag(tags[0]):null; }

    function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch{} }
    function load(){ try{ const raw=localStorage.getItem(STORAGE_KEY); const arr=raw?JSON.parse(raw):[]; return Array.isArray(arr)?arr.filter(x=>x&&typeof x.title==='string'&&typeof x.text==='string').map(x=>({id:String(x.id||uid()), title:x.title, text:x.text, tags:Array.isArray(x.tags)?x.tags.map(String).filter(Boolean):[]})):[]; }catch{ return []; } }
    function saveSettings(){ try{ localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }catch{} }
    function loadSettings(){ try{ const raw=localStorage.getItem(SETTINGS_KEY); const s=raw?JSON.parse(raw):null; if(s){ if(s.filterMode==='all'||s.filterMode==='any') settings.filterMode=s.filterMode; } }catch{} }
    function loadTagColors(){ try{ const raw=localStorage.getItem(TAGS_KEY); const t=raw?JSON.parse(raw):{}; tagColors=(t&&typeof t==='object'&&!Array.isArray(t))?t:{}; }catch{ tagColors={}; } }
    function saveTagColors(){ try{ localStorage.setItem(TAGS_KEY, JSON.stringify(tagColors)); }catch{} }

    /* Search / Filter / Sort */
    function matchesActiveFilters(it){ if(activeFilters.size===0) return true; const set=new Set((it.tags||[]).map(norm)); if(settings.filterMode==='all'){ for(const f of activeFilters){ if(!set.has(f)) return false; } return true; } for(const f of activeFilters){ if(set.has(f)) return true; } return false; }
    function matchesSearch(it){ if(!searchQuery) return true; if(it.title.toLowerCase().includes(searchQuery)) return true; if((it.tags||[]).some(t=>t.toLowerCase().includes(searchQuery))) return true; return (it.text||'').toLowerCase().includes(searchQuery); }
    function scoreItem(it){ let s=0; if(matchesSearch(it)) s+=2; if(matchesActiveFilters(it)) s+=2; const title=it.title.toLowerCase(); if(searchQuery){ if(title.startsWith(searchQuery)) s+=1; if((it.tags||[]).some(t=>t.toLowerCase()===searchQuery)) s+=0.5; } return s; }
    function itemsForRender(){ return [...state].sort((a,b)=>{ const da=scoreItem(a), db=scoreItem(b); if(db!==da) return db-da; return a.title.localeCompare(b.title); }); }
    function matchingItems(){ return state.filter(it=>matchesActiveFilters(it)&&matchesSearch(it)); }

    /* Tags helpers */
    function allTags(){ const map=new Map(); for(const it of state){ for(const t of (it.tags||[])){ const k=norm(t); if(!map.has(k)) map.set(k,t); } } return [...map.entries()].sort((a,b)=>a[1].localeCompare(b[1])); }
    function tagsArray(){ return allTags().map(([key,label])=>({ key, label, color: colorForTag(label) })); }
    function tagsList(){ return allTags().map(([_,label])=>label); }

    function populateTagDatalist(){ const tags=allTags().map(([_,l])=>l); tagsDatalist.innerHTML=tags.map(t=>`<option value="${t}"></option>`).join(''); }
    function renderTagChips(container,currentTags=[],onToggle){
      container.innerHTML=''; const cur=new Set(currentTags.map(norm)); const tagPairs=allTags();
      if(tagPairs.length===0){ const empty=document.createElement('div'); empty.className='small'; empty.style.opacity='.8'; empty.textContent='No tags yet. Add some above.'; container.appendChild(empty); return; }
      for(const [k,label] of tagPairs){
        const chip=document.createElement('button'); chip.type='button'; chip.className='tag-chip'; chip.setAttribute('aria-pressed',String(cur.has(k)));
        const dot=document.createElement('span'); dot.className='chip-dot'; dot.style.background=colorForTag(label);
        const text=document.createElement('span'); text.textContent=label;
        chip.append(dot,text);
        chip.style.borderColor=cur.has(k)?colorForTag(label):'#2a313b';
        chip.style.opacity=cur.has(k)?'1':'.85';
        chip.addEventListener('click',()=>{
          if(cur.has(k)) cur.delete(k); else cur.add(k);
          chip.setAttribute('aria-pressed',String(cur.has(k)));
          chip.style.borderColor=cur.has(k)?colorForTag(label):'#2a313b';
          chip.style.opacity=cur.has(k)?'1':'.85';
          onToggle([...cur].map(x=>tagPairs.find(([nk])=>nk===x)?.[1]||x));
        });
        container.appendChild(chip);
      }
    }
    function syncInputWithChips(inputEl,container){
      const update=()=>{ const tags=splitTags(inputEl.value); renderTagChips(container,tags,(nt)=>{ inputEl.value=nt.join(', '); }); };
      inputEl._chipHandler&&inputEl.removeEventListener('input',inputEl._chipHandler);
      inputEl._chipHandler=()=>update();
      inputEl.addEventListener('input',inputEl._chipHandler);
      update();
    }

    /* Cards */
    function createItemEl(item){
      const wrapper=document.createElement('div'); wrapper.className='item'; wrapper.dataset.id=item.id; if(!IS_TOUCH&&ALLOW_DND) wrapper.draggable=true; wrapper.setAttribute('role','listitem');
      const btn=document.createElement('button'); btn.className='copy-btn'; btn.type='button'; btn.title=`Copy: ${item.title}`;
      const accent=firstTagColor(item.tags); if(accent){ btn.style.setProperty('--accent',accent); btn.style.borderColor=accent+'55'; }
      const left=document.createElement('div'); left.className='leftcol';
      const titleEl=document.createElement('div'); titleEl.className='title'; titleEl.textContent=item.title; left.appendChild(titleEl);
      if(item.tags?.length){
        const tagsEl=document.createElement('div'); tagsEl.className='tags';
        for(const tg of item.tags.slice(0,6)){ const chip=document.createElement('span'); chip.className='tag'; chip.textContent=tg; chip.style.borderColor=colorForTag(tg)+'80'; tagsEl.appendChild(chip); }
        left.appendChild(tagsEl);
      }else{ const hint=document.createElement('div'); hint.className='hint'; hint.textContent='Click to copy'; left.appendChild(hint); }
      const icon=document.createElement('span'); icon.setAttribute('aria-hidden','true'); icon.textContent='⧉';
      btn.append(left,icon);
      btn.addEventListener('click',async()=>{ try{ await navigator.clipboard.writeText(item.text); showToast(`Copied “${item.title}”.`);}catch{ showToast('Copy failed.'); } });

      const menu=document.createElement('div'); menu.className='ctxmenu'; menu.setAttribute('role','menu');
      const selRow=document.createElement('label'); selRow.className='row'; selRow.textContent='Select';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=selectedIds.has(item.id);
      cb.addEventListener('click',(e)=>e.stopPropagation());
      cb.addEventListener('change',()=>{ if(cb.checked) selectedIds.add(item.id); else selectedIds.delete(item.id); updateDeleteSelectedBtn(); });
      selRow.prepend(cb);
      const renRow=document.createElement('div'); renRow.className='row'; renRow.textContent='Rename'; renRow.addEventListener('click',()=>openRename(item.id));
      const tagsRow=document.createElement('div'); tagsRow.className='row'; tagsRow.textContent='Edit tags'; tagsRow.addEventListener('click',()=>openEditTags(item.id));
      const delRow=document.createElement('div'); delRow.className='row danger-act'; delRow.textContent='Delete'; delRow.addEventListener('click',()=>handleDelete(item.id));
      menu.append(selRow,renRow,tagsRow,document.createElement('hr'),delRow);
      wrapper.addEventListener('contextmenu',(e)=>{ e.preventDefault(); document.querySelectorAll('.ctxmenu.show').forEach(m=>m.classList.remove('show')); menu.style.top='6px'; menu.style.right='6px'; menu.classList.add('show'); });
      document.addEventListener('click',(e)=>{ const inMenu=e.target.closest?.('.ctxmenu'); if(!inMenu) menu.classList.remove('show'); });

      if(!IS_TOUCH&&ALLOW_DND){
        wrapper.draggable=true;
        wrapper.addEventListener('dragstart',(e)=>{ wrapper.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain', item.id); });
        wrapper.addEventListener('dragend',()=>{ wrapper.classList.remove('dragging'); grid.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over')); });
        wrapper.addEventListener('dragover',(e)=>{ e.preventDefault(); wrapper.classList.add('drag-over'); e.dataTransfer.dropEffect='move'; });
        wrapper.addEventListener('dragleave',()=> wrapper.classList.remove('drag-over'));
        wrapper.addEventListener('drop',(e)=>{ e.preventDefault(); wrapper.classList.remove('drag-over'); const src=e.dataTransfer.getData('text/plain'); const dst=wrapper.dataset.id; if(!src||!dst||src===dst) return;
          const from=state.findIndex(x=>x.id===src), to=state.findIndex(x=>x.id===dst); if(from<0||to<0) return; const [m]=state.splice(from,1); state.splice(to,0,m); save(); applyFiltersAndRender(); showToast('Reordered.'); });
      }

      wrapper.append(btn,menu);
      return wrapper;
    }

    /* Rendering */
    function renderAll(){
      grid.innerHTML=''; itemsForRender().forEach(it=>grid.appendChild(createItemEl(it)));
      const idsInState=new Set(state.map(x=>x.id)); for(const id of [...selectedIds]) if(!idsInState.has(id)) selectedIds.delete(id);
      updateDeleteSelectedBtn(); rebuildFiltersUI(); populateTagDatalist();
      if(manageDlg.open){ syncInputWithChips(tagsCreateInput,existingTags); }
      if(tagsDlg.open){ syncInputWithChips(tagsInput,editExistingTags); }
    }
    function applyFiltersAndRender(){
      grid.innerHTML=''; itemsForRender().forEach(it=>grid.appendChild(createItemEl(it)));
      const idsInState=new Set(state.map(x=>x.id)); for(const id of [...selectedIds]) if(!idsInState.has(id)) selectedIds.delete(id);
      updateDeleteSelectedBtn(); updateFiltersSummary(); updateClearButton();
    }

    /* Filters UI */
    function rebuildFiltersUI(){
      filtersList.innerHTML='';
      const tags=allTags();
      if(tags.length===0){ filtersList.innerHTML=`<div class="small" style="opacity:.8">No filters yet. Add tags when creating or editing.</div>`; }
      else{
        for(const [k,label] of tags){
          const row=document.createElement('label'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.fontSize='14px';
          const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=activeFilters.has(k);
          cb.addEventListener('change',()=>{ if(cb.checked) activeFilters.add(k); else activeFilters.delete(k); applyFiltersAndRender(); });
          const dot=document.createElement('span'); dot.className='chip-dot'; dot.style.background=colorForTag(label);
          const span=document.createElement('span'); span.textContent=label;
          row.append(cb,dot,span); filtersList.appendChild(row);
        }
      }
      updateFiltersSummary(); updateFilterModeButton();
    }
    function updateFiltersSummary(){ const count=activeFilters.size; filtersBtn.textContent=`Filters (${count})`; const list=[...activeFilters]; const modeTxt=settings.filterMode.toUpperCase(); filtersSummary.textContent=count?`Mode: ${modeTxt} · Active: ${list.join(', ')}`:`Mode: ${modeTxt} · No active filters.`; }
    function updateFilterModeButton(){ filtersModeToggle.textContent=`Mode: ${settings.filterMode.toUpperCase()}`; }
    const filtersSelectAll=()=>{ for(const [k] of allTags()) activeFilters.add(k); rebuildFiltersUI(); applyFiltersAndRender(); }
    const filtersClear=()=>{ activeFilters.clear(); rebuildFiltersUI(); applyFiltersAndRender(); }
    const toggleFilterMode=()=>{ settings.filterMode=settings.filterMode==='all'?'any':'all'; saveSettings(); updateFilterModeButton(); applyFiltersAndRender(); }
    function toggleFiltersDropdown(){ filtersDd.classList.toggle('show'); }
    function closeFiltersDropdown(e){ if(!filtersDd.classList.contains('show')) return; const within=filtersDd.contains(e.target)||filtersBtn.contains(e.target); if(!within) filtersDd.classList.remove('show'); }

    /* CRUD */
    function handleCreate(){
      const title=sanitizeLabel(titleInput.value);
      const text=sanitizeText(textInput.value);
      const tags=splitTags(tagsCreateInput.value);
      if(!text){ showToast('Enter text to copy.'); textInput.focus(); return; }
      state.push({id:uid(), title, text, tags}); save(); applyFiltersAndRender();
      titleInput.value=''; textInput.value=''; tagsCreateInput.value=''; titleInput.focus(); counter+=1; showToast('Added.'); renderAll();
    }
    function handleDelete(id){
      const idx=state.findIndex(x=>x.id===id); if(idx<0) return;
      if(!confirm(`Delete “${state[idx].title}”?`)) return;
      selectedIds.delete(id); state.splice(idx,1); save(); applyFiltersAndRender(); showToast('Deleted.'); renderAll();
    }
    function handleDeleteSelected(){
      const ids=[...selectedIds]; if(!ids.length) return;
      if(!confirm(`Delete ${ids.length} selected item(s)?`)) return;
      const set=new Set(ids); state=state.filter(x=>!set.has(x.id)); selectedIds.clear(); save(); applyFiltersAndRender(); showToast('Deleted selected.'); renderAll();
    }
    function updateDeleteSelectedBtn(){ const n=selectedIds.size; deleteSelectedBtn.textContent=`Delete Selected (${n})`; deleteSelectedBtn.disabled=n===0; updateSelectToggleBtn(); }
    function updateSelectToggleBtn(){ const total=matchingItems().length; const n=selectedIds.size; const all= total>0 && n===total; selectToggleBtn.textContent=all?'Clear Selection':'Select All'; selectToggleBtn.disabled=total===0; }
    function handleSelectToggle(){
      const items=matchingItems(); const all=items.every(it=>selectedIds.has(it.id));
      if(all){ for(const it of items) selectedIds.delete(it.id); } else { for(const it of items) selectedIds.add(it.id); }
      updateDeleteSelectedBtn();
    }

    /* Rename / Edit Tags */
    function openRename(id){ const it=state.find(x=>x.id===id); if(!it) return; renameInput.value=it.title; renameDlg._target=id; openDialogSafe(renameDlg); renameInput.focus(); renameInput.select(); }
    renameSaveBtn.addEventListener('click',()=>{ const id=renameDlg._target; const idx=state.findIndex(x=>x.id===id); if(idx>=0){ state[idx].title=sanitizeLabel(renameInput.value); save(); applyFiltersAndRender(); showToast('Renamed.'); } closeDialogSafe(renameDlg); renameDlg._target=null; });

    function openEditTags(id){
      const it=state.find(x=>x.id===id); if(!it) return;
      tagsInput.value=(it.tags||[]).join(', '); tagsDlg._target=id;
      openDialogSafe(tagsDlg); tagsInput.focus(); tagsInput.select();
      populateTagDatalist(); syncInputWithChips(tagsInput, editExistingTags);
    }
    tagsSaveBtn.addEventListener('click',()=>{ const id=tagsDlg._target; const idx=state.findIndex(x=>x.id===id);
      if(idx>=0){ state[idx].tags=splitTags(tagsInput.value); save(); applyFiltersAndRender(); showToast('Tags updated.'); }
      closeDialogSafe(tagsDlg); tagsDlg._target=null; renderAll();
    });

    /* -------- Export semantics -------- */
    function nowStamp(){ const d=new Date(); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`; }
    function buildButtonsPayload(){ return { version:1, exportedAt:new Date().toISOString(), buttons: state, tags: tagsArray() }; }       // buttons + tags + colors
    function buildTagsPayload(){ return { version:1, exportedAt:new Date().toISOString(), tags: tagsArray() }; }                             // tags + colors
    function downloadJSON(obj,prefix){ const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`${prefix}-${nowStamp()}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    async function copyJSON(obj){ try{ await navigator.clipboard.writeText(JSON.stringify(obj,null,2)); return true; }catch{ return false; } }

    function openExportPopover(anchorBtn){
      const r=anchorBtn.getBoundingClientRect(); const vw=window.innerWidth, m=8;
      let left=r.left + r.width/2; left=Math.max(m,Math.min(left,vw-m));
      exportPop.style.left=`${left}px`; exportPop.style.top=`${r.bottom+8}px`; exportPop.style.transform='translateX(-50%)';
      exportPop.classList.add('show'); exportBtn.setAttribute('aria-expanded','true');
    }
    function closeExportPopover(){ exportPop.classList.remove('show'); exportBtn.setAttribute('aria-expanded','false'); }
    function isInsideExport(e){ return exportPop.contains(e?.target)||exportBtn.contains(e?.target); }

    exportBtn.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); if(exportPop.classList.contains('show')) closeExportPopover(); else openExportPopover(exportBtn); });
    exportPop.addEventListener('click',async(e)=>{
      const act=e.target?.dataset?.act; if(!act) return;
      if(act==='download-buttons'){
        if(!state.length){ showToast('No buttons to export.'); return closeExportPopover(); }
        downloadJSON(buildButtonsPayload(),'buttons'); showToast('Downloaded buttons (with tags & colors).');
      }else if(act==='copy-buttons'){
        if(!state.length){ showToast('No buttons to copy.'); return closeExportPopover(); }
        showToast((await copyJSON(buildButtonsPayload()))?'Copied buttons (with tags & colors).':'Copy failed.');
      }else if(act==='download-tags'){
        if(!allTags().length){ showToast('No tags to export.'); return closeExportPopover(); }
        downloadJSON(buildTagsPayload(),'tags'); showToast('Downloaded tags (with colors).');
      }else if(act==='copy-tags'){
        if(!allTags().length){ showToast('No tags to copy.'); return closeExportPopover(); }
        showToast((await copyJSON(buildTagsPayload()))?'Copied tags (with colors).':'Copy failed.');
      }
      closeExportPopover();
    });

    /* Smart Import */
    function mergeButtons(arr,dedupe){
      if(!Array.isArray(arr)) return 0;
      const existing=new Set(state.map(x=>norm(x.title))); let added=0;
      for(const x of arr){
        if(!x||typeof x.title!=='string'||typeof x.text!=='string') continue;
        const title=x.title.trim(), text=sanitizeText(x.text); const tags=Array.isArray(x.tags)?x.tags.map(String).filter(Boolean):[];
        if(!text) continue; if(dedupe && existing.has(norm(title))) continue;
        state.push({id:uid(), title, text, tags}); existing.add(norm(title)); added++;
      }
      return added;
    }
    function mergeTagColorsFromObject(list){
      let changed=0; if(!Array.isArray(list)) return 0;
      for(const t of list){
        const label=(t&&(t.label||t.name||t.key))?String(t.label||t.name||t.key):null;
        const hex=t&&(t.hex||t.color); const nhex=normalizeHex(hex);
        if(!label||!nhex) continue; const k=norm(label);
        if(tagColors[k]!==nhex){ tagColors[k]=nhex; changed++; }
      }
      if(changed) saveTagColors();
      return changed;
    }
    function parseCSV(text,sep){
      const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean); if(!lines.length) return [];
      return lines.map(l=>{ const parts=l.split(sep).map(s=>s.trim()); const [title='',txt='',tags='']=parts; return { title, text:txt, tags:splitTags(tags) }; });
    }
    function parsePipes(text){
      const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      return lines.map(l=>{ const parts=l.split('|').map(s=>s.trim()); const [title='',txt='',tags='']=parts; return { title, text:txt, tags:splitTags(tags) }; });
    }
    function parsePlain(text){
      const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      return lines.map((l,i)=>({ title:(l.length>30?l.slice(0,30)+'…':l)||`Line ${i+1}`, text:l, tags:[] }));
    }
    function looksLikeJSON(s){ const t=String(s||'').trim(); return t.startsWith('{')||t.startsWith('['); }
    function smartImport(text,dedupe){
      let addedButtons=0, colored=0;
      try{
        if(looksLikeJSON(text)){
          const data=JSON.parse(text);
          if(Array.isArray(data)){ addedButtons+=mergeButtons(data,dedupe); }
          else if(data && typeof data==='object'){
            if(Array.isArray(data.buttons)) addedButtons+=mergeButtons(data.buttons,dedupe);
            if(Array.isArray(data.tags)) colored+=mergeTagColorsFromObject(data.tags);
            if(addedButtons===0 && colored===0 && data.title && data.text){ addedButtons+=mergeButtons([data],dedupe); }
          }
        }else{
          const head=text.slice(0,200);
          if(head.includes(',') && text.includes('\n')) addedButtons+=mergeButtons(parseCSV(text,','),dedupe);
          else if(head.includes('\t') && text.includes('\n')) addedButtons+=mergeButtons(parseCSV(text,'\t'),dedupe);
          else if(text.includes('|')) addedButtons+=mergeButtons(parsePipes(text),dedupe);
          else addedButtons+=mergeButtons(parsePlain(text),dedupe);
        }
      }catch{
        const head=text.slice(0,200);
        if(head.includes(',') && text.includes('\n')) addedButtons+=mergeButtons(parseCSV(text,','),dedupe);
        else if(head.includes('\t') && text.includes('\n')) addedButtons+=mergeButtons(parseCSV(text,'\t'),dedupe);
        else if(text.includes('|')) addedButtons+=mergeButtons(parsePipes(text),dedupe);
        else addedButtons+=mergeButtons(parsePlain(text),dedupe);
      }
      return { addedButtons, colored };
    }
    async function importFileBlob(file,dedupe){
      if(!/\.json$/i.test(file.name) && file.type!=='application/json'){ showToast('Not a JSON file.'); return; }
      try{
        const text=await file.text(); const { addedButtons, colored }=smartImport(text,dedupe);
        if(addedButtons===0 && colored===0){ showToast('No recognizable data found.'); return; }
        saveTagColors(); save(); applyFiltersAndRender(); renderAll(); showToast(`Imported ${addedButtons} item(s), colored ${colored} tag(s).`);
      }catch{ showToast('Import failed.'); }
    }

    /* Color editor */
    function buildColorRow(label){
      const k=norm(label); const currentEffective=colorForTag(label); const currentOverride=(tagColors[k]&&normalizeHex(tagColors[k]))||'';
      const row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='auto 90px 120px auto'; row.style.alignItems='center'; row.style.gap='8px';
      const name=document.createElement('div'); name.textContent=label; name.style.whiteSpace='nowrap'; name.style.overflow='hidden'; name.style.textOverflow='ellipsis';
      const colorInput=document.createElement('input'); colorInput.type='color'; colorInput.value=currentOverride||currentEffective;
      const hexInput=document.createElement('input'); hexInput.className='control'; hexInput.placeholder='#rrggbb'; hexInput.value=currentOverride||currentEffective;
      const resetBtn=document.createElement('button'); resetBtn.type='button'; resetBtn.className='util'; resetBtn.textContent='Reset';
      colorInput.addEventListener('input',()=>{ hexInput.value=colorInput.value.toLowerCase(); hexInput.setCustomValidity(''); hexInput.style.borderColor=''; });
      hexInput.addEventListener('input',()=>{ const nh=normalizeHex(hexInput.value); if(nh){ colorInput.value=nh; hexInput.setCustomValidity(''); hexInput.style.borderColor=''; } else { hexInput.setCustomValidity('Invalid hex'); hexInput.style.borderColor='#e5484d'; } });
      resetBtn.addEventListener('click',()=>{ delete tagColors[k]; colorInput.value=colorForTag(label); hexInput.value=colorInput.value; hexInput.setCustomValidity(''); hexInput.style.borderColor=''; });
      row.append(name,colorInput,hexInput,resetBtn);
      return { row, commit:()=>{ const nh=normalizeHex(hexInput.value); if(nh && tagColors[k]!==nh){ tagColors[k]=nh; return 1; } return 0; } };
    }
    function openColorsDialog(){
      colorsList.innerHTML=''; const tags=allTags();
      if(tags.length===0){ const empty=document.createElement('div'); empty.className='small'; empty.style.opacity='.8'; empty.textContent='No tags yet. Add a button with tags to start coloring.'; colorsList.appendChild(empty); }
      else{
        const rows=[]; for(const [,label] of tags){ const r=buildColorRow(label); colorsList.appendChild(r.row); rows.push(r); }
        colorsSaveBtn.onclick=()=>{ let changes=0; rows.forEach(r=>changes+=r.commit()); saveTagColors(); closeDialogSafe(colorsDlg); applyFiltersAndRender(); renderAll(); showToast(changes?`Saved ${changes} color(s).`:'No color changes.'); };
      }
      colorsCancelBtn.onclick=()=>closeDialogSafe(colorsDlg);
      openDialogSafe(colorsDlg);
    }

    /* Dialog helpers */
    function openDialogSafe(dlg){ if(dlg?.showModal) dlg.showModal(); else { dlg?.setAttribute('open',''); document.body.style.overflow='hidden'; } }
    function closeDialogSafe(dlg){ if(dlg?.close) dlg.close(); else { dlg?.removeAttribute('open'); document.body.style.overflow=''; } }

    /* Wire up */
    openManageBtn.addEventListener('click',()=>{ openDialogSafe(manageDlg); titleInput.focus(); populateTagDatalist(); syncInputWithChips(tagsCreateInput,existingTags); });
    createBtn.addEventListener('click',(e)=>{ e.preventDefault(); handleCreate(); });
    closeManageBtn.addEventListener('click',(e)=>{ e.preventDefault(); closeDialogSafe(manageDlg); });
    clearBtn.addEventListener('click',()=>{ if(!state.length){ showToast('Nothing to clear.'); return; } if(!confirm('Delete all buttons?')) return; state=[]; selectedIds.clear(); activeFilters.clear(); save(); applyFiltersAndRender(); showToast('Cleared.'); renderAll(); });

    selectToggleBtn.addEventListener('click',handleSelectToggle);
    deleteSelectedBtn.addEventListener('click',handleDeleteSelected);

    filtersBtn.addEventListener('click',(e)=>{ e.stopPropagation(); toggleFiltersDropdown(); });
    filtersModeToggle.addEventListener('click',(e)=>{ e.stopPropagation(); toggleFilterMode(); });
    filtersSelectAllBtn.addEventListener('click',(e)=>{ e.stopPropagation(); filtersSelectAll(); });
    filtersClearBtn.addEventListener('click',(e)=>{ e.stopPropagation(); filtersClear(); });

    openColorsBtn.addEventListener('click',openColorsDialog);

    document.addEventListener('click',(e)=>{ closeFiltersDropdown(e); if(exportPop.classList.contains('show') && !isInsideExport(e)) closeExportPopover(); });
    window.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'&&(manageDlg.open)){ e.preventDefault(); handleCreate(); return; } if(e.key==='Escape'){ if(exportPop.classList.contains('show')) closeExportPopover(); if(filtersDd.classList.contains('show')) filtersDd.classList.remove('show'); } });
    window.addEventListener('scroll',()=>{ if(exportPop.classList.contains('show')) closeExportPopover(); },{passive:true});
    window.addEventListener('resize',()=>{ document.body.classList.toggle('compact', window.innerWidth<=740); if(exportPop.classList.contains('show')) closeExportPopover(); });
    window.addEventListener('orientationchange',()=>{ document.body.classList.toggle('compact', window.innerWidth<=740); });

    // Search
    function updateClearButton(){ searchClear.classList.toggle('show', Boolean(searchInput.value.trim())); }
    function setSearch(q){ searchInput.value=q; searchQuery=q.trim().toLowerCase(); updateClearButton(); applyFiltersAndRender(); }
    let searchTimer=null;
    searchInput.addEventListener('input',()=>{ clearTimeout(searchTimer); searchTimer=setTimeout(()=>setSearch(searchInput.value),150); });
    searchClear.addEventListener('click',()=>{ setSearch(''); searchInput.focus(); });
    searchInput.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && searchInput.value){ e.preventDefault(); setSearch(''); searchInput.focus(); } else if(e.key==='Enter'){ e.preventDefault(); const items=matchingItems(); if(items.length){ navigator.clipboard.writeText(items[0].text).then(()=>showToast(`Copied “${items[0].title}”.`),()=>showToast('Copy failed.')); } else showToast('No results to copy.'); } });

    // Import dialog
    function openImportDialog(){ importJSON.value=''; importDedupe.checked=true; openDialogSafe(importDlg); importJSON.focus(); }
    openImportBtn.addEventListener('click',openImportDialog);
    importCancelBtn.addEventListener('click',()=>closeDialogSafe(importDlg));
    importRunBtn.addEventListener('click',()=>{
      const raw=importJSON.value||''; if(!raw.trim()){ showToast('Paste JSON or choose a file.'); return; }
      const { addedButtons, colored }=smartImport(raw, importDedupe.checked);
      if(addedButtons===0 && colored===0){ showToast('Nothing imported.'); return; }
      saveTagColors(); save(); applyFiltersAndRender(); renderAll(); closeDialogSafe(importDlg);
      showToast(`Imported ${addedButtons} item(s), colored ${colored} tag(s).`);
    });
    const setDzHover=(on)=> importDropzone.classList.toggle('dz-hover', on);
    function triggerFile(){ importFile.value=''; importFile.click(); }
    importDropzone.addEventListener('click',triggerFile);
    importDropzone.addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); triggerFile(); } });
    ['dragenter','dragover'].forEach(ev=> importDropzone.addEventListener(ev,(e)=>{ e.preventDefault(); e.stopPropagation(); setDzHover(true); }));
    ['dragleave','dragend','drop'].forEach(ev=> importDropzone.addEventListener(ev,(e)=>{ e.preventDefault(); e.stopPropagation(); if(ev!=='drop') setDzHover(false); }));
    importDropzone.addEventListener('drop',async(e)=>{ const f=e.dataTransfer?.files?.[0]; if(!f){ setDzHover(false); return; } await importFileBlob(f, importDedupe.checked); setDzHover(false); closeDialogSafe(importDlg); });
    importFile.addEventListener('change',async(e)=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; await importFileBlob(f, importDedupe.checked); importFile.value=''; closeDialogSafe(importDlg); });

    // Init
    window.addEventListener('DOMContentLoaded',()=>{
      document.body.classList.toggle('compact', window.innerWidth<=740);
      loadSettings(); loadTagColors(); state=load();
      applyFiltersAndRender(); rebuildFiltersUI(); populateTagDatalist(); updateClearButton();
    });
  </script>
</body>
</html>
